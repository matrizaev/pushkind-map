{% extends "base.html" %}
{% block content %}

<section class="placemarkForm" id="placemarkForm">
	<div class="container my-2 border bg-light">
		{% set errorsList = form.name.errors + form.longitude.errors + form.latitude.errors + form.tags.errors + form.price.errors + form.description.errors + form.is_vendor.errors %}
		{% if errorsList|length > 0 %}
			<div class = "row my-2">
				<div class="col">
					<div class="alert alert-danger" role="alert">
						{% for error in  errorsList %}
							{{ error }}<br>
						{% endfor %}
					</div>
				</div>
			</div>
		{% endif %}
		<div class = "row my-2">
			<div class="col">
				<button id="collapsedFormControl" class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapsedForm" aria-expanded="false" aria-controls="collapsedForm">
					Добавить метку
				</button>
			</div>
		</div>	
		<div class="collapse"  id="collapsedForm">
			<form method="POST">
				{{ form.csrf_token }}
				<div class="form-row">
					<div class="form-group col-md-6">
					  {{ form.longitude.label }}
					  {{ form.longitude(class_ = 'form-control') }}
					</div>
					<div class="form-group col-md-6">
					  {{ form.latitude.label }}
					  {{ form.latitude(class_ = 'form-control') }}
					</div>
				</div>
				<div class="form-group">
					{{ form.name.label }}
					{{ form.name(class_ = 'form-control', autofocus = '') }}
				</div>
				<div class="form-group">
					{{ form.description.label }}
					{{ form.description(class_ = 'form-control') }}
				</div>
				<div class="form-row" id="tagsRowCollapse">
					<div class="form-group col-md-6">
						{{ form.tags.label }}
						{{ form.tags(class_ = 'form-control') }}
					</div>
					<div class="form-group col-md-6">
						{{ form.price.label }}
						{{ form.price(class_ = 'form-control', value = 0.0) }}
					</div>
				</div>
				<div class="form-group">
					<div class="form-check">
						{{ form.is_vendor(class_ = 'form-check-input') }}
						{{ form.is_vendor.label(class_ = 'form-check-label') }}
					</div>
				</div>
				{{ form.submit(class_ = 'btn btn-primary mb-2') }}
			</form>
		</div>
	</div>
</section>
{% set tagsList = current_user.GetTags() %}
{% if tagsList|length > 0 %}
	<section class="tagsCloud" id="tagsCloud">
		<div class="container my-2 border bg-light">
			<div class="row">
				<div class="col">
				{% for tag in tagsList %}
					{% if tag.name == active_tag %}
						<a href="{{ url_for('main.ShowIndex', active_tag = tag.name) }}" class="badge badge-success tag font-weight-bold">{{ tag.name }}</a>
					{% else %}
						<a href="{{ url_for('main.ShowIndex', active_tag = tag.name) }}" class="badge badge-info tag">{{ tag.name }}</a>
					{% endif %}
				{% endfor %}
				</div>
			</div>
		</div>
	</section>
{% endif %}
<section class="mapWrapper h-100" id="mapWrapper">
	<div class="container border bg-light h-100">
		<div class="row my-2">
			<div class="input-group col-md-10">
				<label for="formControlRange" id="distanceLabel">Фильтр дистанций: 2500км</label>
				<input type="range" class="form-control-range" id="distanceRange" min="10" max="5000" value="2500" onchange="FilterRoutesByDistance()">
			</div>
			<div class="col-md-2 text-right">
				<button id="resetMap" class="btn btn-primary">Сброс</button>
			</div>
		</div>
		<div class="row h-100">
			<div class="col h-100">
				<div id="map" class="h-75 w-100"></div>
			</div>
		</div>
	</div>
</section>

{% endblock %}

{% block scripts %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=a72d01fe-d9fe-4c9a-b10f-00df800ff9b5&lang=ru_RU" type="text/javascript"></script>
<script type="text/javascript">


	var is_vendor = $('#is_vendor'),
	tagsRowCollapse = $('#tagsRowCollapse'),
	resetMapButton = $('#resetMap');

	tagsRowCollapse.hide();
	is_vendor.prop('checked', false);

	$('.tag').on('click', function(event){
		if (is_vendor.prop('checked') && Boolean($('#collapsedFormControl').attr('aria-expanded')))
		{
			event.preventDefault();
			tagsValue = $('#tags').val() + ' ' + $(this).text();
			$('#tags').val(tagsValue);
		}
	});

	is_vendor.on('click', function() {
	   if($(this).is(':checked')) {
		  tagsRowCollapse.show();
		  tagsRowCollapse.find('input').attr('required', true);
	   } else {
		  tagsRowCollapse.hide();
		  tagsRowCollapse.find('input').attr('required', false);
	   }
	});

	resetMapButton.on('click', function() {
		if (routesList['length'] > 0)
		{
			endpointsList.forEach(function(endpoint){
					endpoint.options.set("visible", true);
			});
			routesList.forEach(function(route){
				route.destroy();
			});
		}
	});
	var vendorsList = [];
	var endpointsList = [];
	var routesList = [];
	var myMap;
	ymaps.ready(init);
	function init(){
		var endpointsTemplateList = [
			{% for placemark in current_user.EndpointPlacemarks() %}
				{{ placemark|safe }},
			{% endfor %}
		];
		var vendorsTemplateList = [
			{% for placemark in current_user.VendorPlacemarks(active_tag) %}
				{{ placemark|safe }},
			{% endfor %}
		];
   
		myMap = new ymaps.Map("map", {
			center: [55.76, 37.64],
			zoom: 7
		});
		
		myMap.events.add('click', function(e){
			var coords = e.get('coords');
			$('#longitude').val(coords[0]);
			$('#latitude').val(coords[1]);
		});
		
		vendorsTemplateList.forEach(AddVendorObject);
		endpointsTemplateList.forEach(AddEndpointObject);
		
		if (vendorsList['length'] > 0)
		{
			myMap.setCenter(vendorsList[0].geometry.getCoordinates());
		}
	}
	function OnPlacemarkClick(e)
	{
		if (vendorsList['length'] > 0)
		{
			var target = e.get('target');
			endpointsList.forEach(function(endpoint){
				if (endpoint != target) 
					endpoint.options.set("visible", false);
			});
			routesList.forEach(function(route){
				route.destroy();
			});
			routesList = [];
			vendorsList.forEach(function(vendor){
				var route = new ymaps.multiRouter.MultiRoute({    
				referencePoints: [
					vendor.geometry.getCoordinates(),
					target.geometry.getCoordinates()
				]
				}, {boundsAutoApply: true, wayPointVisible:false});
				myMap.geoObjects.add(route);
				route.events.add('update', function(e){
					route = e.get('target');
					filterDistance = $('#distanceRange').val() * 1000;
					currentDistance = route.getActiveRoute().properties.get("distance").value;
					if (filterDistance > currentDistance)
					{
						route.options.set("visible", true);
					}
					else
					{
						route.options.set("visible", false);
					}
				});
				routesList.push(route);
			});
		}
	}
	function AddEndpointObject(placemark, index)
	{
		var balloonContentBody = '<p>' + placemark.description + '</p><a class="badge badge-danger" href="{{ url_for('main.RemovePlacemark') }}?id='+placemark.id+'" onclick="return confirm(\'Удалить?\')">&mdash;</a>';
		var endpoint = new ymaps.Placemark(placemark.coordinates, {iconContent:placemark.name, balloonContentHeader: placemark.name, balloonContentBody:balloonContentBody}, {preset: 'islands#blueStretchyIcon'});
		myMap.geoObjects.add(endpoint);
		endpoint.events.add('click', OnPlacemarkClick);
		endpointsList.push(endpoint);
	}
	function AddVendorObject(placemark)
	{
		var balloonContentBody = '<p>' + placemark.description + '<br> Цена: '+ placemark.price+'</p><a class="badge badge-danger" href="{{ url_for('main.RemovePlacemark') }}?id='+placemark.id+'" onclick="return confirm(\'Удалить?\')">&mdash;</a>';
		var vendor = new ymaps.Placemark(placemark.coordinates, {iconContent:placemark.name, balloonContentHeader: placemark.name, balloonContentBody:balloonContentBody}, {preset: 'islands#redStretchyIcon'});
		myMap.geoObjects.add(vendor);
		vendorsList.push(vendor);
	}
	function FilterRoutesByDistance()
	{
		filterDistance = $('#distanceRange').val();
		$('#distanceLabel').text('Фильтр дистанций: '+ filterDistance + 'км');
		filterDistance *= 1000;
		routesList.forEach(function(route){
			currentDistance = route.getActiveRoute().properties.get("distance").value;
			if (filterDistance > currentDistance)
			{
				route.options.set("visible", true);
			}
			else
			{
				route.options.set("visible", false);
			}
		});
	}
</script>
{% endblock %}