{% extends "base.html" %}
{% set tags_list = current_user.GetTags() %}
{% block content %}

<section class="placemarkForm" id="placemarkForm">
	<div class="container my-2 border bg-light">
		<div class = "row my-2">
			<div class="col">
				<button id="collapsedFormControl" class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapsedForm" aria-expanded="false" aria-controls="collapsedForm">
					Добавить метку
				</button>
			</div>
		</div>	
		<div class="collapse"  id="collapsedForm">
			<form method="POST" action="{{ url_for('main.AddPlacemark', active_tag = active_tag) }}">
				{{ add_form.csrf_token(id='addCSRF') }}
				<div class="form-row">
					<div class="form-group col-md-6">
					  {{ add_form.longitude.label }}
					  {{ add_form.longitude(class_ = 'form-control') }}
					</div>
					<div class="form-group col-md-6">
					  {{ add_form.latitude.label }}
					  {{ add_form.latitude(class_ = 'form-control') }}
					</div>
				</div>
				<div class="form-group">
					{{ add_form.name.label }}
					{{ add_form.name(class_ = 'form-control', autofocus = '') }}
				</div>
				<div class="form-group">
					{{ add_form.description.label }}
					{{ add_form.description(class_ = 'form-control') }}
				</div>
				<div id="tagsListCollapse">
				</div>
				<div class="form-group">
					<div class="form-check">
						{{ add_form.is_vendor(class_ = 'form-check-input') }}
						{{ add_form.is_vendor.label(class_ = 'form-check-label') }}
					</div>
				</div>
				{{ add_form.submit(class_ = 'btn btn-primary mb-2') }}
			</form>
		</div>
	</div>
</section>
{% if tags_list|length > 0 %}
	<section class="tagsCloud" id="tagsCloud">
		<div class="container my-2 border bg-light">
			<div class="row">
				<div class="col">
				{% for tag in tags_list %}
					{% if tag.id in active_tag %}
						{% set rem_active_tags = active_tag |reject('equalto', tag.id)| list %}
						<a data-tagId="{{ tag.id }}" href="{{ url_for('main.ShowIndex', active_tag = rem_active_tags) }}" class="badge badge-success tag font-weight-bold">{{ tag.name }}</a>
					{% else %}
						{% set add_active_tags = active_tag + [tag.id] %}
						<a data-tagId="{{ tag.id }}" href="{{ url_for('main.ShowIndex', active_tag = add_active_tags) }}" class="badge badge-primary tag">{{ tag.name }}</a>
					{% endif %}
				{% endfor %}
				</div>
			</div>
		</div>
	</section>
{% endif %}
<section class="mapWrapper h-100" id="mapWrapper">
	<div class="container border bg-light h-100">
		{% if active_tag|length > 0 %}
			<div class="form-group row my-2">
				<div class="input-group col-md-10">
					<label for="distanceRange" id="distanceLabel">Фильтр дистанций: 2500км</label>
					<input type="range" class="form-control-range" id="distanceRange" min="10" max="5000" value="2500" onchange="FilterRoutesByDistance()">
				</div>
				<div class="col-md-2 text-right">
					<button id="resetMap" class="btn btn-primary">Сброс</button>
				</div>
			</div>
			<div class="form-group">
				<label for="subTagSelect">Материал</label>
				<select class="form-control" id="subTagSelect">
					{% for subtag in current_user.GetActiveSubtags(active_tag) %}
						<option value="{{ subtag.name }}">{{ subtag.name }}</option>
					{% endfor %}
				</select>
			</div>
		{% endif %}
		<div class="row h-100 my-2">
			<div class="col h-100">
				<div id="map" class="h-75 w-100"></div>
			</div>
		</div>
	</div>
</section>

<div class="modal fade" id="editPlacemarkModal" tabindex="-1" role="dialog" aria-labelledby="editPlacemarkLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editPlacemarkLabel">Редактирование метки</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="POST" action="{{ url_for('main.EditPlacemark', active_tag = active_tag) }}">
				<div class="modal-body">
					{{ edit_form.csrf_token(id='editCSRF') }}
					{{ edit_form.id(class_ = 'd-none', hidden = '') }}
					{{ edit_form.is_vendor(class_ = 'd-none', hidden = '') }}
					<div class="form-group">
						{{ edit_form.name.label }}
						{{ edit_form.name(class_ = 'form-control') }}
					</div>
					<div class="form-group">
						{{ edit_form.description.label }}
						{{ edit_form.description(class_ = 'form-control') }}
					</div>
					<div id = "editPricesGroup">	
					</div>
				</div>
				<div class="modal-footer">
					{{ edit_form.submit(class_ = 'btn btn-primary') }}
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
				</div>
			</form>
		</div>
	</div>
</div>


<div class="d-none" id="templates">
	<div id="addTagTemplate" data-index="0" class="tagsHierarchy">
		<div class="form-row my-2">
			<div class="col-10">
				<input type="text" class="form-control" placeholder="Тег" name="tags-_-name" required list="tagsList">
			</div>
			<div class="col-2 text-right">
				<a class="btn btn-danger removeTagButton"><img class="octicon" src="http://admin.pushkind.com/static/octicons/dash.svg" alt="Удалить"></a>
				<a class="btn btn-primary appendTagButton"><img class="octicon" src="http://admin.pushkind.com/static/octicons/plus.svg" alt="Добавить"></a>
			</div>	
		</div>
		<div class="form-row my-2" data-subIndex ="0">
			<div class="col-2">
				&nbsp;
			</div>
			<div class="col-4">
				<input type="text" class="form-control subtag" placeholder="Материал" name="tags-_-prices-0-name" required list="subtagsList">
			</div>
			<div class="col-2">
				<input type="number" class="form-control price" step="any" placeholder="Цена" name="tags-_-prices-0-price" required>
			</div>
			<div class="col-2">
				<input type="text" class="form-control units" placeholder="Единицы" name="tags-_-prices-0-units">
			</div>
			<div class="col-2 text-right">
				<a class="btn btn-info appendSubTagButton"><img class="octicon" src="http://admin.pushkind.com/static/octicons/plus.svg" alt="Добавить"></a>
			</div>	
		</div>
	</div>
	<div class="form-row my-2" id="editPricesTemplate">
		<div class="col">
			<input type="text" class = "form-control subtag" name="prices-_-name" value="" required readonly>
		</div>
		<div class="col">
			<input name="prices-_-price" type="number" step="any" value="" class="form-control price" required>
		</div>
		<div class="col">
			<input name="prices-_-units" type="text" value="" class="form-control units" placeholder="Единицы">
		</div>
		<div class="col text-right">
			<a class="btn btn-danger removeSubtagButton"><img class="octicon" src="http://admin.pushkind.com/static/octicons/dash.svg" alt="Удалить"></a>
		</div>
	</div>
	<div id="placemarkBaloonTemplate">
		<pre></pre>
		<h6 class="d-none">Цены</h6>
		<p class="d-none font-weight-bold">
		</p>
		<a href="{{ url_for('main.RemovePlacemark', active_tag = active_tag, id = 'replace_me') }}" class="badge badge-danger" onclick="return confirm('Удалить?')">
			<img class="octicon" src="http://admin.pushkind.com/static/octicons/x.svg" alt="Удалить">
		</a>&nbsp;
		<a class="badge badge-primary" data-toggle="modal" data-target="#editPlacemarkModal">
			<img class="octicon" src="http://admin.pushkind.com/static/octicons/pencil.svg" alt="Редактировать">
		</a>
	</div>
</div>


<datalist id="tagsList" class="d-none">
	{% for tag in tags_list %}
		<option value="{{tag.name}}">
	{% endfor %}
</datalist>

<datalist id="subtagsList" class="d-none">

	{% for tag in tags_list %}
		{% for subtag in tags_list[tag] %}
			<option value="{{subtag.name.split('/')[1]}}">
		{% endfor %}
	{% endfor %}
</datalist>


{% endblock %}

{% block scripts %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=a72d01fe-d9fe-4c9a-b10f-00df800ff9b5&lang=ru_RU"></script>
<script>
	//
	//Globals
	//
	var	vendorsList = [],
		endpointsList = [],
		routesList = [],
		myMap;

	//
	//Events handlers
	//
	$(function() {
		tagsListCollapse = $('#tagsListCollapse');
		tagsListCollapse.hide();
		$('#addIsVendor').prop('checked', false);

		tagsListCollapse.on('click', '.appendTagButton', AddTag);
		tagsListCollapse.on('click', '.removeTagButton', function(event){
			var target = $(event.target);
			var parent = target.closest('.tagsHierarchy');
			if (tagsListCollapse.children().length > 1)
				parent.remove();
		});
		$('#editPricesGroup').on('click', '.removeSubtagButton', function(event){
			var target = $(event.target);
			var parent = target.closest('.form-row');
			if (parent.parent().children().length > 2)
				parent.remove();
		});
		tagsListCollapse.on('click', '.appendSubTagButton', function(event){
			var target = $(event.target);
			var parent = target.closest('.tagsHierarchy');
			var content = parent.find('.form-row').last();
			var lastIndex = Number(content.attr('data-subIndex'));
			content = content.clone();
			content.attr('data-subIndex', lastIndex + 1);
			var input = content.find('input.subtag');
			var name = input.attr('name').replace('-prices-'+lastIndex+'-name', '-prices-'+(lastIndex + 1)+'-name');
			input.attr('name', name);
			var input = content.find('input.price');
			var name = input.attr('name').replace('-prices-'+lastIndex+'-price', '-prices-'+(lastIndex + 1)+'-price');
			input.attr('name', name);
			var input = content.find('input.units');
			var name = input.attr('name').replace('-prices-'+lastIndex+'-units', '-prices-'+(lastIndex + 1)+'-units');
			input.attr('name', name);			
			parent.append(content);
		});

		$('#addIsVendor').on('click', function() {
		   if($(this).is(':checked')) {
			  tagsListCollapse.show();
			  AddTag();
		   } else {
			  tagsListCollapse.hide();
			  tagsListCollapse.empty();
		   }
		});

		$('#resetMap').on('click', ResetMap);
		$('#subTagSelect').on('change', ResetMap);
		
		$('#editPlacemarkModal').on('shown.bs.modal', function (e) {
			index = e.relatedTarget.getAttribute('data-placemarkIndex');
			if (e.relatedTarget.getAttribute('data-placemarkType') == 'vendor')
			{
				placemark = vendorsList[index];
				var editPrices = $('#editPricesGroup');
				editPrices.show();
				editPrices.empty();
				editPrices.append('<h6>Цены</h6>');
				var template = $('#editPricesTemplate');
				var i = 0;
				for (var key in placemark.template['prices'])
				{
					var content = template.clone();
					var input = content.find('input.subtag');
					input.val(key);
					var name = input.attr('name').replace('_', i);
					input.attr('name', name);
					input = content.find('input.price');
					input.val(placemark.template['prices'][key][0]);
					name = input.attr('name').replace('_', i);
					input.attr('name', name);
					input = content.find('input.units');
					input.val(placemark.template['prices'][key][1]);
					name = input.attr('name').replace('_', i);
					input.attr('name', name);
					i++;
					editPrices.append(content);
				}
				$("#editIsVendor").prop('checked', true);
			}
			else
			{
				placemark = endpointsList[index];
				$('#editPricesGroup').hide();
				$("#editIsVendor").prop('checked', false);
			}
			$('#editId').val(placemark.template.id);
			$('#editName').val(decodeEntities(placemark.template.name));
			$('#editDescription').val(placemark.template.description);
		});
	});

	function ResetMap(){
		routesList.forEach(function(route){
			route.destroy();
		});
		routesList = [];
		endpointsList.forEach(function(endpoint){
			endpoint.options.set("visible", true);
		});
		vendorsList.forEach(function(vendor){
			vendor.options.set('preset', 'islands#redStretchyIcon');
			vendor.properties.set('iconContent', vendor.template['name']);
		});
	}

	ymaps.ready(function(){
		var endpointsTemplateList = [
			{% for placemark in current_user.EndpointPlacemarks() %}
				{{ placemark|safe }},
			{% endfor %}
		];
		var vendorsTemplateList = [
			{% for placemark in current_user.VendorsPlacemarks(active_tag) %}
				{{ placemark|safe }},
			{% endfor %}
		];
   
		myMap = new ymaps.Map("map", {
			center: [55.76, 37.64],
			zoom: 7
		});
		
		myMap.events.add('click', function(e){
			var coords = e.get('coords');
			$('#addLongitude').val(coords[0]);
			$('#addLatitude').val(coords[1]);
		});
		
		vendorsTemplateList.forEach(AddVendorObject);
		endpointsTemplateList.forEach(AddEndpointObject);
		
		if (vendorsList['length'] > 0)
		{
			myMap.setCenter(vendorsList[0].geometry.getCoordinates());
		}
		else if (endpointsList['length'] > 0)
		{
			myMap.setCenter(endpointsList[0].geometry.getCoordinates());
		}
	});
	
	//
	//Utility functions
	//
	function AddEndpointObject(placemark, index)
	{
	
		var content = $('#placemarkBaloonTemplate').clone();
		content.find('pre:first').text(placemark.description);
		var elem = content.find('a:first');
		var urlForRemove = elem.attr('href').replace('replace_me', placemark.id);;
		elem.attr('href', urlForRemove);
		elem = content.find('a:last');
		elem.attr('data-placemarkType', 'endpoint');
		elem.attr('data-placemarkIndex', index);
		var endpoint = new ymaps.Placemark(placemark.coordinates, {iconContent:placemark.name, balloonContentHeader: placemark.name, balloonContentBody:content.html()}, {preset: 'islands#blueStretchyIcon'});
		myMap.geoObjects.add(endpoint);
		endpoint.events.add('click', OnPlacemarkClick);
		endpoint.template = placemark;
		endpointsList.push(endpoint);
	}
	
	function AddVendorObject(placemark, index)
	{
		var content = $('#placemarkBaloonTemplate').clone();
		content.find('pre:first').text(placemark.description);
		var elem = content.find('a:first');
		var urlForRemove = elem.attr('href').replace('replace_me', placemark.id);;
		elem.attr('href', urlForRemove);
		elem = content.find('a:last');
		elem.attr('data-placemarkType', 'vendor');
		elem.attr('data-placemarkIndex', index);
		content.find('h6').removeClass('d-none');
		var elem = content.find('p');
		elem.removeClass('d-none');
		for (var key in placemark['prices'])
		{
			elem.append(key + ': '+ placemark['prices'][key][0] + placemark['prices'][key][1] + '<br>');
		}
		var vendor = new ymaps.Placemark(placemark.coordinates, {iconContent:placemark.name, balloonContentHeader: placemark.name, balloonContentBody:content.html()}, {preset: 'islands#redStretchyIcon'});
		myMap.geoObjects.add(vendor);
		vendor.template = placemark;
		vendorsList.push(vendor);
	}
	
	function OnPlacemarkClick(e)
	{
		if (vendorsList['length'] > 0)
		{
			var target = e.get('target');
			endpointsList.forEach(function(endpoint){
				if (endpoint != target) 
					endpoint.options.set("visible", false);
			});
			routesList.forEach(function(route){
				route.destroy();
			});
			routesList = [];
			
			var currentSubtag = $('#subTagSelect').val();
			vendorsList.forEach(function(vendor){
				if (currentSubtag in vendor.template['prices'])
				{
					var route = new ymaps.multiRouter.MultiRoute({
					referencePoints: [
						vendor.geometry.getCoordinates(),
						target.geometry.getCoordinates()
					]
					}, {boundsAutoApply: true, wayPointVisible:false});
					route.vendor = vendor;
					myMap.geoObjects.add(route);
					route.events.add('update', FilterRoutesByDistance);
					routesList.push(route);
				}
			});
			
		}
	}
	
	function FilterRoutesByDistance()
	{
		filterDistance = $('#distanceRange').val();
		$('#distanceLabel').text('Фильтр дистанций: '+ filterDistance + 'км');
		filterDistance *= 1000;
		vendorsList.forEach(function(vendor){
			vendor.options.set('preset', 'islands#redStretchyIcon');
		});
		var currentSubtag = $('#subTagSelect').val();
		var minIndex = 0;
		var minimalPrice = vendorsList[minIndex].template['prices'][currentSubtag][0];
		routesList.forEach(function(route, index){
			activeRoute = route.getActiveRoute();
			if (activeRoute)
			{
				currentDistance = activeRoute.properties.get("distance").value;
				route.activeDistance = currentDistance;
				var header = route.vendor.template['name']+' <b>('+Math.round(currentDistance/1000.0)+'км/'+route.vendor.template['prices'][currentSubtag][0]+route.vendor.template['prices'][currentSubtag][1]+')</b>';
				route.vendor.properties.set('iconContent', header);
				if (filterDistance > currentDistance)
				{
					route.options.set("visible", true);
					if (route.vendor.template['prices'][currentSubtag][0] < minimalPrice)
					{
						minimalPrice = route.vendor.template['prices'][currentSubtag][0];
						minIndex = index;
					}
					else if (route.vendor.template['prices'][currentSubtag][0] == minimalPrice)
					{
						if (currentDistance < routesList[minIndex].activeDistance)
						{
							minIndex = index;
						}
					}
				}
				else
				{
					route.options.set("visible", false);
				}
			}
		});
		routesList[minIndex].vendor.options.set('preset', 'islands#greenStretchyIcon');
	}
	function AddTag()
	{
		var content = $("#addTagTemplate");
		var tagsIndex = Number(content.attr('data-index'));
		content.attr('data-index', tagsIndex + 1);
		content = content.clone();
		content.find('input').each(function(){
			var name = $(this).attr('name').replace('_', tagsIndex);
			$(this).attr('name', name);
		});
		content.removeAttr('id');
		$('#tagsListCollapse').append(content);
	}
	
	var decodeEntities = (function () {
        //create a new html document (doesn't execute script tags in child elements)
        var doc = document.implementation.createHTMLDocument("");
        var element = doc.createElement('div');

        function getText(str) {
            element.innerHTML = str;
            str = element.textContent;
            element.textContent = '';
            return str;
        }

        function decodeHTMLEntities(str) {
            if (str && typeof str === 'string') {
                var x = getText(str);
                while (str !== x) {
                    str = x;
                    x = getText(x);
                }
                return x;
            }
        }
        return decodeHTMLEntities;
    })();
	
</script>
{% endblock %}