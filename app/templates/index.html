{% extends "base.html" %}

{% block styles %}
<style>
	.vendorShortPrice{color:rgb(192,0,0)}
</style>
{% endblock %}

{% block content %}

<div class="container my-1">
	<div class="row">
		<div class="col">
			<img src="http://map.pushkind.com/static/logo.png" alt="Логотип">	
		</div>
		<div class="col text-right">
			{{ current_user.email }}(<a href="{{ url_for('auth.PerformLogout') }}">выйти</a>)
		</div>
	</div>
</div>
<div class="container my-1">
	<div class="row">
		<div class="col">
			{% for tag in tags %}
				{% if tag.id in active_tags %}
					{% set rem_active_tags = active_tags |reject('equalto', tag.id)| list %}
					<a href="{{ url_for('main.ShowIndex', tag = rem_active_tags) }}" class="badge badge-primary tag font-weight-bold">{{ tag.name }}</a>
				{% else %}
					{% set add_active_tags = active_tags + [tag.id] %}
					<a href="{{ url_for('main.ShowIndex', tag = add_active_tags) }}" class="badge badge-light border border-dark tag">{{ tag.name }}</a>
				{% endif %}
			{% endfor %}
		</div>
	</div>
</div>
<div class="container my-1">
	<div class="row">
		<div class="col">
			<form method="GET" action="{{ url_for('main.ShowIndex') }}">
				<input type="search" name="search" placeholder="Поиск по материалам..." class="form-control" value="{{ search if search is not none }}" list="subtagsList">
			</form>
		</div>
	</div>
</div>
<div class="my-1 container">
	{% if active_tags|length > 0 or search is not none %}
		<div class="row my-1">
			<div class="col-md-2">
				Материал:
			</div>
			<div class="col-md">
				<select class="form-control" id="subTagSelect">
					{% if search is none %}
						<option value="all">Все</option>			
					{% endif %}
					{% for subtag in active_subtags %}
						<option value="{{ subtag.name }}">{{ subtag.name }}</option>
					{% endfor %}
				</select>
			</div>
			<div class="col-md-2 text-right">
				<button id="resetMap" class="btn btn-link">Сброс маршрутов</button>
			</div>
		</div>
		<div class="row my-1">
			<div class="col-md-10">
				Расстояние не более: <span id="distanceLabel">500</span> км
				<input type="range" class="form-control-range" id="distanceRange" min="10" max="10000" value="500" onchange="FilterRoutesByDistance()">
			</div>
			<div class="col-md-2 text-right">
				<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapsedSyncForm" aria-expanded="false" aria-controls="collapsedSyncForm">
					Синхронизация
				</button>
			</div>
		</div>
	{% else%}
		<div class="row my-1">
			<div class="col text-right">
				<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapsedSyncForm" aria-expanded="false" aria-controls="collapsedSyncForm">
					Синхронизация
				</button>
			</div>
		</div>
	{% endif %}
	<div class="collapse" id="collapsedSyncForm">
		<form class="my-2" method="POST" action="{{ url_for('main.SyncPlacemarks', tag = active_tags) }}">
			<h6>Синхронизровать метки с Google-таблицей</h6>
			{{ sync_form.csrf_token(id='syncCSRF') }}
			<div class="row">
				<div class="col">
					{{ sync_form.url(class_ = 'form-control mb-1', placeholder='https://drive.google.com/drive') }}
				</div>
				<div class="col-lg-2">
					{{ sync_form.submit(class_ = 'btn btn-primary') }}
				</div>
			</div>
		</form>
	</div>
</div>


<div class="my-1 container-fluid d-flex h-100 flex-column">
	<div class="row flex-fill d-flex">
		<div class="col" id="map">
		</div>
	</div>
</div>

<div class="modal fade" id="vendorCardModal" tabindex="-1" role="dialog" aria-labelledby="vendorCardModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="vendorCardModalLabel">Карточка поставщика</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<div class="row">
					<div class="col font-weight-bold">
						Короткое название
					</div>
					<div class="col" id="vendorCardName">
					</div>
				</div>
				<div class="row">
					<div class="col font-weight-bold">
						Полное название
					</div>
					<div class="col" id="vendorCardFullName">
					</div>
				</div>
				<div class="row">
					<div class="col font-weight-bold">
						Адрес
					</div>
					<div class="col" id="vendorCardAddress">
					</div>
				</div>
				<div class="row">
					<div class="col font-weight-bold">
						Контактное лицо
					</div>
					<div class="col" id="vendorCardContact">
					</div>
				</div>
				<div class="row">
					<div class="col font-weight-bold">
						Телефон
					</div>
					<div class="col" id="vendorCardPhone">
					</div>
				</div>
				<div class="row">
					<div class="col font-weight-bold">
						Электронная почта
					</div>
					<div class="col">
						<a id="vendorCardEmail">
							
						</a>
					</div>
				</div>
				<div class="row">
					<div class="col">
						<a id="vendorCardWebsite">
							Вебсайт
						</a>
					</div>
					<div class="col">
						<a id="vendorCardPresentation">
							Презентация
						</a>
					</div>
					<div class="col">
						<a id="vendorCardPrice">
							Прайс-лист
						</a>
					</div>
				</div>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
			</div>
		</div>
	</div>
</div>


<div class="modal fade " id="showFullPriceModal" tabindex="-1" role="dialog" aria-labelledby="showFullPriceModalLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="showFullPriceModalLabel">Прайс-лист</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<div class="modal-body">
				<table class="table">
					<thead>
						<tr>
							<th scope="col">#</th>
							<th scope="col">Материал</th>
							<th scope="col">ЕИ</th>
							<th scope="col">Цена</th>
						</tr>
					</thead>
				<tbody id="vendorFullPrice">
					
				</tbody>
				</table>
			</div>
			<div class="modal-footer">
				<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
			</div>
		</div>
	</div>
</div>


<div class="d-none" id="templates">
	<div id="vendorBaloonTemplate">
		<p class="vendorDescription"></p>
		<span>Цены:</span>
		<p class="vendorShortPrice"></p>
		<p>
			<a href="#" data-toggle="modal" data-target="#vendorCardModal" class="vendorModalButton" >О компании</a>
			<a href="#" data-toggle="modal" data-target="#showFullPriceModal" class="vendorModalButton">Прайс-лист</a>
		</p>
	</div>
</div>


<datalist id="tagsList" class="d-none">
	{% for tag in tags %}
		<option value="{{tag.name}}">
	{% endfor %}
</datalist>

<datalist id="subtagsList" class="d-none">
	{% for tag in tags %}
		{% for subtag in tags[tag] %}
			<option value="{{subtag.name.split(' / ')[1]}}">
		{% endfor %}
	{% endfor %}
</datalist>


{% endblock %}

{% block scripts %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=a72d01fe-d9fe-4c9a-b10f-00df800ff9b5&lang=ru_RU"></script>
<script>
	//
	//Globals
	//
	var	vendorsList = [],
		endpointsList = [],
		routesList = [],
		myMap;

	//
	//Events handlers
	//
	$(function() {
	
	
		//Subtags search
		$('input[type=search]').on('search', function () {
			$(this).parent().submit();
		});

		$('#resetMap').on('click', ResetMap);
		$('#subTagSelect').on('change', ResetMap);
		
		$('#showFullPriceModal').on('shown.bs.modal', function (e) {
			var index = e.relatedTarget.getAttribute('data-placemarkIndex');
			if (e.relatedTarget.getAttribute('data-placemarkType') == 'vendor')
			{
				var placemark = vendorsList[index];				
				var vendorFullPrice = $("#vendorFullPrice");
				vendorFullPrice.empty();
				var index = 0;
				for (subtag in placemark.template['prices']){
					var row = "<tr><td>"+index+"</td><td>"+subtag+"</td><td>"+placemark.template['prices'][subtag][1]+"</span></td><td><span title='"+placemark.template['prices'][subtag][2]+"'>"+placemark.template['prices'][subtag][0]+"</td></tr>";
					vendorFullPrice.append(row);
					index += 1;
				}
			}
		});	
		
		$('#vendorCardModal').on('shown.bs.modal', function (e) {
			var index = e.relatedTarget.getAttribute('data-placemarkIndex');
			if (e.relatedTarget.getAttribute('data-placemarkType') == 'vendor')
			{
				var placemark = vendorsList[index];
				$("#vendorCardName").text(placemark.template['name']);
				$("#vendorCardFullName").text(placemark.template['full_name']);
				$("#vendorCardAddress").text(placemark.template['address']);
				$("#vendorCardContact").text(placemark.template['contact']);
				$("#vendorCardPhone").text(placemark.template['phone']);
				$("#vendorCardEmail").attr('href', placemark.template['email']);
				$("#vendorCardEmail").text(placemark.template['email']);
				if (placemark.template['website'] != '')
					$("#vendorCardWebsite").attr('href', placemark.template['website']);
				if (placemark.template['presentation'] != '')	
					$("#vendorCardPresentation").attr('href', placemark.template['presentation']);
				$("#vendorCardPrice").attr('href', placemark.template['price_url']);
			}
		});
	});

	function ResetMap(){
		routesList.forEach(function(route){
			route.destroy();
		});
		routesList = [];
		endpointsList.forEach(function(endpoint){
			endpoint.options.set("visible", true);
		});
		var currentSubtag = $('#subTagSelect').val();
		vendorsList.forEach(function(vendor){
			if (currentSubtag == 'all' || currentSubtag in vendor.template['prices'])
			{
				vendor.options.set('preset', 'islands#redStretchyIcon');
				vendor.active = true;
			}
			else
			{
				vendor.options.set('preset', 'islands#grayStretchyIcon');
				vendor.active = false;
			}
			vendor.properties.set('iconContent', vendor.template.sequence);
		});
	}
	
	ymaps.ready(function(){
		var endpointsTemplateList = [
			{% for placemark in current_user.EndpointPlacemarks() %}
				{{ placemark|safe }},
			{% endfor %}
		];
		var vendorsTemplateList = [
			{% for placemark in current_user.VendorsPlacemarks(active_tags, search) %}
				{{ placemark|safe }},
			{% endfor %}
		];

		myMap = new ymaps.Map("map", {
			center: [56.84, 60.60],
			zoom: 4,
			controls: ['zoomControl', 'searchControl', 'typeSelector',  'fullscreenControl', 'routeButtonControl']
		});
		
		vendorsTemplateList.forEach(AddVendorObject);
		endpointsTemplateList.forEach(AddEndpointObject);
	});
	
	//
	//Utility functions
	//
	function AddEndpointObject(placemark, index)
	{
		var endpoint = new ymaps.Placemark(placemark.coordinates, {iconContent:placemark.name}, {preset: 'islands#blueStretchyIcon'});
		myMap.geoObjects.add(endpoint);
		endpoint.events.add('click', OnPlacemarkClick);
		endpoint.template = placemark;
		endpointsList.push(endpoint);
	}
	
	function AddVendorObject(placemark, index)
	{
		var content = $('#vendorBaloonTemplate').clone();
		content.find('p.vendorDescription').text(placemark.description);
		
		elem = content.find('a.vendorModalButton');
		elem.attr('data-placemarkType', 'vendor');
		elem.attr('data-placemarkIndex', index);
		
		var elem = content.find('p.vendorShortPrice');
		
		[
			{% for subtag in active_subtags %}
				"{{ subtag.name }}",
			{% endfor %}
		].forEach(function(subtag){
			if (subtag in placemark['prices'])
				elem.append(subtag + ': <span class="font-weight-bold" title="'+placemark['prices'][subtag][2]+'">'+ placemark['prices'][subtag][0]+'</span> '+ placemark['prices'][subtag][1] + '<br>');
		});
		
		var vendor = new ymaps.Placemark(placemark.coordinates, {balloonContentHeader: placemark.name, balloonContentBody:content.html(), iconContent:placemark.sequence});
		myMap.geoObjects.add(vendor);
		vendor.template = placemark;
		vendorsList.push(vendor);
		
		var currentSubtag = $('#subTagSelect').val();
		if (currentSubtag == 'all' || currentSubtag in placemark['prices'])
		{
			vendor.options.set('preset', 'islands#redStretchyIcon');
			vendor.active = true;
		}
		else
		{
			vendor.options.set('preset', 'islands#grayStretchyIcon');
			vendor.active = false;
		}
	}
	
	function OnPlacemarkClick(e)
	{
		var target = e.get('target');
		if (vendorsList['length'] > 0)
		{
			endpointsList.forEach(function(endpoint){
				if (endpoint != target) 
					endpoint.options.set("visible", false);
			});
			routesList.forEach(function(route){
				route.destroy();
			});
			routesList = [];
			
			myMap.setCenter(target.geometry.getCoordinates(),6);
			vendorsList.forEach(function(vendor){
				if (vendor.active)
				{
					var route = new ymaps.multiRouter.MultiRoute({
					referencePoints: [
						vendor.geometry.getCoordinates(),
						target.geometry.getCoordinates()
					]
					}, {boundsAutoApply: false, wayPointVisible:false});
					route.vendor = vendor;
					myMap.geoObjects.add(route);
					route.events.add('update', FilterRoutesByDistance);
					routesList.push(route);
				}
			});	
		}
	}
	
	function FilterRoutesByDistance()
	{
		var filterDistance = Number($('#distanceRange').val());
		$('#distanceLabel').text(filterDistance);
		filterDistance *= 1000;
		var currentSubtag = $('#subTagSelect').val();
		var minIndex = 0;
		var minimalPrice = null;
		if (currentSubtag == "all")
		{
			vendorsList.forEach(function(vendor){
				vendor.options.set('preset', 'islands#redStretchyIcon');
				vendor.active = true;
			});
			routesList.forEach(function(route, index){
				var activeRoute = route.getActiveRoute();
				if (activeRoute)
				{
					var currentDistance = activeRoute.properties.get("distance").value;
					route.activeDistance = currentDistance;
					
					if (filterDistance > currentDistance)
					{
						var header = route.vendor.template['name']+' ('+Math.round(currentDistance/1000.0)+' км)';
						route.vendor.properties.set('iconContent', header);
						route.options.set("visible", true);
						if (currentDistance < routesList[minIndex].activeDistance)
						{
							minIndex = index;
						}
					}
					else
					{
						route.options.set("visible", false);
						route.vendor.properties.set('iconContent', '');
					}
				}
			});		
		}
		else
		{
			vendorsList.forEach(function(vendor){
				if (currentSubtag in vendor.template['prices'])
				{
					vendor.options.set('preset', 'islands#redStretchyIcon');
					vendor.active = true;
				}
				else
				{
					vendor.options.set('preset', 'islands#grayStretchyIcon');
					vendor.active = false;
				}
			});
			routesList.forEach(function(route, index){
				var activeRoute = route.getActiveRoute();
				if (activeRoute)
				{
					var currentDistance = activeRoute.properties.get("distance").value;
					route.activeDistance = currentDistance;
					
					if (filterDistance > currentDistance)
					{
						route.options.set("visible", true);
						var header = route.vendor.template['name']+' ('+Math.round(currentDistance/1000.0)+' км / <b>'+route.vendor.template['prices'][currentSubtag][0]+'</b> '+route.vendor.template['prices'][currentSubtag][1]+')';
						route.vendor.properties.set('iconContent', header);
						if (minimalPrice === null || route.vendor.template['prices'][currentSubtag][0] < minimalPrice)
						{
							minimalPrice = route.vendor.template['prices'][currentSubtag][0];
							minIndex = index;
						}
						else if (route.vendor.template['prices'][currentSubtag][0] == minimalPrice)
						{
							if (currentDistance < routesList[minIndex].activeDistance)
							{
								minIndex = index;
							}
						}
					}
					else
					{
						route.options.set("visible", false);
						route.vendor.properties.set('iconContent', '');
					}
				}
			});		
		}
		if (routesList.length > 0)
			routesList[minIndex].vendor.options.set('preset', 'islands#greenStretchyIcon');
	}
	
	var decodeEntities = (function () {
		var doc = document.implementation.createHTMLDocument("");
		var element = doc.createElement('div');
		function getText(str) {
			element.innerHTML = str;
			str = element.textContent;
			element.textContent = '';
			return str;
		}
		function decodeHTMLEntities(str) {
			if (str && typeof str === 'string') {
				var x = getText(str);
				while (str !== x) {
					str = x;
					x = getText(x);
				}
				return x;
			}
		}
		return decodeHTMLEntities;
	})();
	
</script>
{% endblock %}