{% extends "base.html" %}
{% block content %}

<section class="placemarkForm" id="placemarkForm">
	<div class="container my-2 border bg-light">
		<div class = "row my-2">
			<div class="col">
				<button id="collapsedFormControl" class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapsedForm" aria-expanded="false" aria-controls="collapsedForm">
					Добавить метку
				</button>
			</div>
		</div>	
		<div class="collapse"  id="collapsedForm">
			<form method="POST" action="{{ url_for('main.AddPlacemark', active_tag = active_tag) }}">
				{{ add_form.csrf_token }}
				<div class="form-row">
					<div class="form-group col-md-6">
					  {{ add_form.longitude.label }}
					  {{ add_form.longitude(class_ = 'form-control') }}
					</div>
					<div class="form-group col-md-6">
					  {{ add_form.latitude.label }}
					  {{ add_form.latitude(class_ = 'form-control') }}
					</div>
				</div>
				<div class="form-group">
					{{ add_form.name.label }}
					{{ add_form.name(class_ = 'form-control', autofocus = '') }}
				</div>
				<div class="form-group">
					{{ add_form.description.label }}
					{{ add_form.description(class_ = 'form-control') }}
				</div>
				<div class="form-row" id="tagsRowCollapse">
					<div class="form-group col-md-6">
						{{ add_form.tags.label }}
						{{ add_form.tags(class_ = 'form-control') }}
					</div>
					<div class="form-group col-md-6">
						{{ add_form.price.label }}
						{{ add_form.price(class_ = 'form-control', value = 0.0) }}
					</div>
				</div>
				<div class="form-group">
					<div class="form-check">
						{{ add_form.is_vendor(class_ = 'form-check-input') }}
						{{ add_form.is_vendor.label(class_ = 'form-check-label') }}
					</div>
				</div>
				{{ add_form.submit(class_ = 'btn btn-primary mb-2') }}
			</form>
		</div>
	</div>
</section>
{% set tagsList = current_user.GetTags() %}
{% if tagsList|length > 0 %}
	<section class="tagsCloud" id="tagsCloud">
		<div class="container my-2 border bg-light">
			<div class="row">
				<div class="col">
				{% for tag in tagsList %}
					{% if tag.name == active_tag %}
						<a href="{{ url_for('main.ShowIndex', active_tag = tag.name) }}" class="badge badge-success tag font-weight-bold">{{ tag.name }}</a>
					{% else %}
						<a href="{{ url_for('main.ShowIndex', active_tag = tag.name) }}" class="badge badge-primary tag">{{ tag.name }}</a>
					{% endif %}
				{% endfor %}
				</div>
			</div>
		</div>
	</section>
{% endif %}
<section class="mapWrapper h-100" id="mapWrapper">
	<div class="container border bg-light h-100">
		<div class="row my-2">
			<div class="input-group col-md-10">
				<label for="formControlRange" id="distanceLabel">Фильтр дистанций: 2500км</label>
				<input type="range" class="form-control-range" id="distanceRange" min="10" max="5000" value="2500" onchange="FilterRoutesByDistance()">
			</div>
			<div class="col-md-2 text-right">
				<button id="resetMap" class="btn btn-primary">Сброс</button>
			</div>
		</div>
		<div class="row h-100">
			<div class="col h-100">
				<div id="map" class="h-75 w-100"></div>
			</div>
		</div>
	</div>
</section>

<div class="modal fade" id="editPlacemarkModal" tabindex="-1" role="dialog" aria-labelledby="editPlacemarkLabel" aria-hidden="true">
	<div class="modal-dialog" role="document">
		<div class="modal-content">
			<div class="modal-header">
				<h5 class="modal-title" id="editPlacemarkLabel">Редактирование метки</h5>
				<button type="button" class="close" data-dismiss="modal" aria-label="Close">
					<span aria-hidden="true">&times;</span>
				</button>
			</div>
			<form method="POST" action="{{ url_for('main.EditPlacemark', active_tag = active_tag) }}">
				<div class="modal-body">
					{{ edit_form.csrf_token }}
					{{ edit_form.id(class_ = 'd-none', hidden = '') }}
					<div class="form-group">
						{{ edit_form.description.label }}
						{{ edit_form.description(class_ = 'form-control') }}
					</div>
					<div class="form-group" id = "editPriceGroup">
						{{ edit_form.price.label }}
						{{ edit_form.price(class_ = 'form-control', value = 0.0) }}
					</div>
				</div>
				<div class="modal-footer">
					{{ edit_form.submit(class_ = 'btn btn-primary') }}
					<button type="button" class="btn btn-secondary" data-dismiss="modal">Закрыть</button>
				</div>
			</form>
		</div>
	</div>
</div>

{% endblock %}

{% block scripts %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=a72d01fe-d9fe-4c9a-b10f-00df800ff9b5&lang=ru_RU" type="text/javascript"></script>
<script type="text/javascript">
	//
	//Globals
	//
	var	addIsVendor = $('#addIsVendor'),
		tagsRowCollapse = $('#tagsRowCollapse'),
		resetMapButton = $('#resetMap'),
		vendorsList = [],
		endpointsList = [],
		routesList = [],
		myMap,
		minimalPrice = 0;
	
	//
	//Events handlers
	//
	$(function() {
		tagsRowCollapse.hide();
		addIsVendor.prop('checked', false);

		$('.tag').on('click', function(event){
			if (addIsVendor.prop('checked') && Boolean($('#collapsedFormControl').attr('aria-expanded')))
			{
				event.preventDefault();
				tagsValue = $('#addTags').val() + ' ' + $(this).text();
				$('#addTags').val(tagsValue);
			}
		});

		addIsVendor.on('click', function() {
		   if($(this).is(':checked')) {
			  tagsRowCollapse.show();
			  tagsRowCollapse.find('input').attr('required', true);
		   } else {
			  tagsRowCollapse.hide();
			  tagsRowCollapse.find('input').attr('required', false);
		   }
		});

		resetMapButton.on('click', function() {
			if (routesList['length'] > 0)
			{
				routesList.forEach(function(route){
					route.destroy();
				});
				routesList = [];
			}
			endpointsList.forEach(function(endpoint){
				endpoint.options.set("visible", true);
			});
			vendorsList.forEach(function(vendor){
				vendor.options.set('preset', 'islands#redStretchyIcon');
			});
		});
		
		$('#editPlacemarkModal').on('shown.bs.modal', function (e) {
			index = e.relatedTarget.getAttribute('data-placemarkIndex');
			if (e.relatedTarget.getAttribute('data-placemarkType') == 'vendor')
			{
				placemark = vendorsList[index];
				$('#editPriceGroup').show();
			}
			else
			{
				placemark = endpointsList[index];
				$('#editPriceGroup').hide();
			}
			$('#editId').val(placemark.placemarkId);
			$('#editPlacemarkLabel').text(placemark.placemarkName);
			$('#editDescription').val(placemark.placemarkDescription);
		});

	});

	ymaps.ready(function(){
		var endpointsTemplateList = [
			{% for placemark in current_user.EndpointPlacemarks() %}
				{{ placemark|safe }},
			{% endfor %}
		];
		var vendorsTemplateList = [
			{% for placemark in current_user.VendorPlacemarks(active_tag) %}
				{{ placemark|safe }},
			{% endfor %}
		];
   
		myMap = new ymaps.Map("map", {
			center: [55.76, 37.64],
			zoom: 7
		});
		
		myMap.events.add('click', function(e){
			var coords = e.get('coords');
			$('#addLongitude').val(coords[0]);
			$('#addLatitude').val(coords[1]);
		});
		
		vendorsTemplateList.forEach(AddVendorObject);
		endpointsTemplateList.forEach(AddEndpointObject);
		
		if (vendorsList['length'] > 0)
		{
			myMap.setCenter(vendorsList[0].geometry.getCoordinates());
		}
	});
	
	//
	//Utility functions
	//
	function AddEndpointObject(placemark, index)
	{
		var urlForRemove = "{{ url_for('main.RemovePlacemark', active_tag = active_tag, id = 'replace_me') }}".replace('replace_me', placemark.id);
		var balloonContentBody =
			'<pre>' + placemark.description + '</pre>' +
			'<div class="row"><div class="col"><a class="badge badge-danger" href="' + urlForRemove + '" onclick="return confirm(\'Удалить?\')">' +
				'<img class="octicon " src="http://admin.pushkind.com/static/octicons/x.svg" alt="edit">' +
			'</a></div><div class="col text-right">'+
			'<a data-placemarkType="endpoint" data-placemarkIndex="' + index + '" class="badge badge-primary" data-toggle="modal" data-target="#editPlacemarkModal">' +
				'<img class="octicon " src="http://admin.pushkind.com/static/octicons/pencil.svg" alt="edit">' +
			'</a></div></div>';
		var endpoint = new ymaps.Placemark(placemark.coordinates, {iconContent:placemark.name, balloonContentHeader: placemark.name, balloonContentBody:balloonContentBody}, {preset: 'islands#blueStretchyIcon'});
		myMap.geoObjects.add(endpoint);
		endpoint.events.add('click', OnPlacemarkClick);
		endpoint.placemarkDescription = placemark.description;
		endpoint.placemarkId = placemark.id;
		endpoint.placemarkName = placemark.name;
		endpointsList.push(endpoint);
	}
	
	function AddVendorObject(placemark, index)
	{
		var urlForRemove = "{{ url_for('main.RemovePlacemark', active_tag = active_tag, id = 'replace_me') }}".replace('replace_me', placemark.id);
		var balloonContentBody =
			'<pre>' + placemark.description + '</pre>' +
			'<p class="font-weight-bold text-right">Цена: '+ placemark.price + '</p>' +
			'<div class="row"><div class="col"><a class="badge badge-danger" href="' + urlForRemove + '" onclick="return confirm(\'Удалить?\')">' +
				'<img class="octicon " src="http://admin.pushkind.com/static/octicons/x.svg" alt="edit">' +
			'</a></div><div class="col text-right">'+
			'<a data-placemarkType="vendor" data-placemarkIndex="' + index + '" class="badge badge-primary" data-toggle="modal" data-target="#editPlacemarkModal">' +
				'<img class="octicon " src="http://admin.pushkind.com/static/octicons/pencil.svg" alt="edit">' +
			'</a></div></div>';
		var vendor = new ymaps.Placemark(placemark.coordinates, {iconContent:placemark.name, balloonContentHeader: placemark.name, balloonContentBody:balloonContentBody}, {preset: 'islands#redStretchyIcon'});
		myMap.geoObjects.add(vendor);
		vendor.placemarkPrice = placemark.price;
		vendor.placemarkDescription = placemark.description;
		vendor.placemarkId = placemark.id;
		vendor.placemarkName = placemark.name;
		vendorsList.push(vendor);
	}
	
	function OnPlacemarkClick(e)
	{
		if (vendorsList['length'] > 0)
		{
			var target = e.get('target');
			endpointsList.forEach(function(endpoint){
				if (endpoint != target) 
					endpoint.options.set("visible", false);
			});
			routesList.forEach(function(route){
				route.destroy();
			});
			routesList = [];
			
			vendorsList.forEach(function(vendor){
				if (vendor.placemarkPrice >= minimalPrice)
					minimalPrice = vendor.placemarkPrice + 1;
				var route = new ymaps.multiRouter.MultiRoute({    
				referencePoints: [
					vendor.geometry.getCoordinates(),
					target.geometry.getCoordinates()
				]
				}, {boundsAutoApply: true, wayPointVisible:false});
				route.vendor = vendor;
				myMap.geoObjects.add(route);
				route.events.add('update', FilterRoutesByDistance);
				routesList.push(route);
			});
			
		}
	}
	
	function FilterRoutesByDistance()
	{
		filterDistance = $('#distanceRange').val();
		$('#distanceLabel').text('Фильтр дистанций: '+ filterDistance + 'км');
		filterDistance *= 1000;

		vendorsList.forEach(function(vendor){
			if (vendor.placemarkPrice >= minimalPrice)
				minimalPrice = vendor.placemarkPrice + 1;
			vendor.options.set('preset', 'islands#redStretchyIcon');
		});
		var minIndex = 0;
		routesList.forEach(function(route, index){
			currentDistance = route.getActiveRoute().properties.get("distance").value;
			if (filterDistance > currentDistance)
			{
				route.options.set("visible", true);
				if (route.vendor.placemarkPrice <= minimalPrice)
				{
					minimalPrice = route.vendor.placemarkPrice;
					minIndex = index;
				}
			}
			else
			{
				route.options.set("visible", false);
			}
		});
		routesList[minIndex].vendor.options.set('preset', 'islands#greenStretchyIcon');
	}
</script>
{% endblock %}