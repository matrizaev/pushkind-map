{% extends "base.html" %}
{% block content %}

<section class="placemarkForm" id="placemarkForm">
	<div class="container my-2 border bg-light">
		<button class="btn btn-link" type="button" data-toggle="collapse" data-target="#collapseExample" aria-expanded="false" aria-controls="collapseExample">
			Добавить метку
		</button>
		<div class="collapse"  id="collapseExample">
			<div class = "row my-2">
				<div class="col">
					{% set errorsList = form.name.errors + form.longitude.errors + form.latitude.errors + form.tags.errors %}
					{% if errorsList|length > 0 %}
						<div class="alert alert-danger" role="alert">
							{% for error in  errorsList %}
								{{ error }}<br>
							{% endfor %}
						</div>
					{% endif %}
				</div>
			</div>
			<form method="POST">
				{{ form.csrf_token }}
				
				<div class="form-row">
					<div class="form-group col-md-6">
					  {{ form.longitude.label }}
					  {{ form.longitude(class_ = 'form-control', autofocus = '') }}
					</div>
					<div class="form-group col-md-6">
					  {{ form.latitude.label }}
					  {{ form.latitude(class_ = 'form-control', autofocus = '') }}
					</div>
				</div>
				
				<div class="form-group">
					{{ form.name.label }}
					{{ form.name(class_ = 'form-control', autofocus = '') }}
				</div>
				<div class="form-group" id="tagsRowCollapse">
					{{ form.tags.label }}
					{{ form.tags(class_ = 'form-control') }}
				</div>
				<div class="form-group">
					<div class="form-check">
						{{ form.is_vendor(class_ = 'form-check-input') }}
						{{ form.is_vendor.label(class_ = 'form-check-label') }}
					</div>
				</div>
				{{ form.submit(class_ = 'btn btn-primary mb-2') }}
			</form>
		</div>
	</div>
</section>
{% set tagsList = current_user.GetTags() %}
{% if tagsList|length > 0 %}
	<section class="tagsCloud" id="tagsCloud">
		<div class="container my-2 border bg-light">
			<div class="row">
				<div class="col">
				{% for tag in tagsList %}
					<a href="{{ url_for('main.ShowIndex', active_tag = tag.name) }}", class="badge badge-info">{{ tag.name }}</a>
				{% endfor %}
				</div>
			</div>
		</div>
	</section>
{% endif %}
<section class="mapWrapper" id="mapWrapper">
	<div class="container my-2 border bg-light">
		<form>
			<div class="form-group">
				<label for="formControlRange" id="distanceLabel">Фильтр дистанций: 500км</label>
				<input type="range" class="form-control-range" id="distanceRange" min="10" max="5000" value="2500" onchange="FilterRoutesByDistance()">
			</div>
		</form>
		<div class="row">
			<div class="col">
				<div id="map" style="width: 100%; height: 400px"></div>
			</div>
		</div>
	</div>
</section>

{% endblock %}

{% block scripts %}
<script src="https://api-maps.yandex.ru/2.1/?apikey=a72d01fe-d9fe-4c9a-b10f-00df800ff9b5&lang=ru_RU" type="text/javascript"></script>
<script type="text/javascript">


	var is_vendor = $('#is_vendor'),
	tagsRowCollapse = $('#tagsRowCollapse');

	tagsRowCollapse.hide();
	is_vendor.prop('checked', false);

	is_vendor.on('click', function() {
	   if($(this).is(':checked')) {
		  tagsRowCollapse.show();
		  tagsRowCollapse.find('input').attr('required', true);
	   } else {
		  tagsRowCollapse.hide();
		  tagsRowCollapse.find('input').attr('required', false);
	   }
	});


	// The ymaps.ready() function will be called when
	// all the API components are loaded and the DOM tree is generated.
	var vendorsList = [
		{% for placemark in current_user.VendorPlacemarks(active_tag) %}
			{
				coordinates: {{ [placemark.longitude,placemark.latitude] }},
				name: "{{ placemark.name }}"
			},
		{% endfor %}
	];
	var endpointsList = [
		{% for placemark in current_user.EndpointPlacemarks() %}
			{
				coordinates: {{ [placemark.longitude,placemark.latitude] }},
				name: "{{ placemark.name }}"
			},
		{% endfor %}
	];
	var routesList = [];
	var myMap;
	ymaps.ready(init);
	function init(){ 
		// Creating the map.    
		myMap = new ymaps.Map("map", {
			// The map center coordinates.
			// Default order: “latitude, longitude”.
			// To not manually determine the map center coordinates,
			// use the Coordinate detection tool.
			center: [55.76, 37.64],
			// Zoom level. Acceptable values:
			// from 0 (the entire world) to 19.
			zoom: 7
		});
		
		myMap.events.add('click', function(e){
			var coords = e.get('coords');
			$('#longitude').val(coords[0]);
			$('#latitude').val(coords[1]);
		});
		
		vendorsList.forEach(AddVendorObject);
		endpointsList.forEach(AddEndpointObject);
		
		if (vendorsList['length'] > 0)
		{
			myMap.setCenter(vendorsList[0].coordinates);
		}
		

	}
	function OnPlacemarkClick(e)
	{
		routesList.forEach(function(route){
			route.destroy();
		});
		routesList = [];
		var target = e.get('target');
		vendorsList.forEach(function(vendor){
			var route = new ymaps.multiRouter.MultiRoute({    
			referencePoints: [
				vendor.coordinates,
				target.geometry.getCoordinates()
			]
			}, {boundsAutoApply: true});
			myMap.geoObjects.add(route);
			/*route.events.add('update', function(e){
				route = e.get('target');
				route.getActiveRoute().balloon.open();
			});*/
			routesList.push(route);
		});
	}
	function AddEndpointObject(placemark)
	{
		var endpoint = new ymaps.Placemark(placemark.coordinates, {balloonContentHeader: placemark.name});
		myMap.geoObjects.add(endpoint);
		endpoint.events.add('click', OnPlacemarkClick);
	}
	function AddVendorObject(placemark)
	{
		var vendor = new ymaps.Placemark(placemark.coordinates, {balloonContentHeader: placemark.name}, {preset: 'islands#redIcon'});
		myMap.geoObjects.add(vendor);
	}
	function FilterRoutesByDistance()
	{
		filterDistance = $('#distanceRange').val();
		$('#distanceLabel').text('Фильтр дистанций: '+ filterDistance + 'км');
		filterDistance *= 1000;
		routesList.forEach(function(route){
			currentDistance = route.getActiveRoute().properties.get("distance").value;
			if (filterDistance > currentDistance)
			{
				route.options.set("visible", true);
			}
			else
			{
				route.options.set("visible", false);
			}
		});
	}
</script>
{% endblock %}